# Scripts Migration & Plugin Registry Implementation Plan

## Background & Context

### Current State
CONSTRUCT currently has two script directories:
- `scripts/` - The old, production scripts that everything currently uses
- `scripts-new/` - The reorganized scripts with better structure and interactive support

The system is in a transition state where:
- Pre-commit hooks point to `scripts/`
- Aliases point to `scripts/`  
- Documentation references `scripts/`
- But development has been happening in `scripts-new/`

### Plugin System State
The plugin system has been partially implemented:
- Pattern files (.md) exist in `patterns/plugins/[category]/[plugin-name]/`
- Validators have been moved from `scripts-new/patterns/` to plugin directories
- Metadata files (.yaml) have been created for each plugin
- BUT: No registry exists, no discovery mechanism, generators mixed with validators

### Why This Migration?
1. Complete the transition from scripts to scripts-new
2. Make plugins discoverable via a registry
3. Separate generators from validators (generators/ directory)
4. Enable pre-configured project templates (like iOS, web, api)
5. Keep the existing "rails" pattern working in create-project.sh

## Phase 1: Complete Plugin Structure

### 1.1 Create generators/ directories

**Current Issue**: `generate-architecture.sh` is in validators/ but it's not a validator

**Action**: Move generator scripts to proper location
```bash
# Move construct-dev generator
mkdir -p patterns/plugins/tooling/construct-dev/generators/
mv patterns/plugins/tooling/construct-dev/validators/generate-architecture.sh \
   patterns/plugins/tooling/construct-dev/generators/architecture.sh
```

### 1.2 Update scripts to check generators/ location

**File**: `scripts-new/construct/update-architecture.sh`

Update line ~127 to check new location first:
```bash
# Look for pattern-specific architecture generator
# Try new generators directory first
local plugin_generator="$CONSTRUCT_CORE/patterns/plugins/$pattern/generators/architecture.sh"
# Then check validators directory (temporary backward compatibility)  
local validator_generator="$CONSTRUCT_CORE/patterns/plugins/$pattern/validators/generate-architecture.sh"
# Finally check old location
local old_generator="$SCRIPTS_ROOT/patterns/$pattern/generate-architecture.sh"

# Use first one found
local generator=""
if [ -f "$plugin_generator" ]; then
    generator="$plugin_generator"
elif [ -f "$validator_generator" ]; then
    generator="$validator_generator"
    echo -e "${YELLOW}  âš ï¸  Generator in validators/ directory for $pattern${NC}"
elif [ -f "$old_generator" ]; then
    generator="$old_generator"
    echo -e "${YELLOW}  âš ï¸  Using legacy generator location for $pattern${NC}"
fi
```

## Phase 2: Plugin Registry System

### 2.1 Create Plugin Registry Generator Script

**New File**: `scripts-new/construct/refresh-plugin-registry.sh`

```bash
#!/bin/bash

# Refresh Plugin Registry
# Scans plugin directories and generates registry.yaml

set -e

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONSTRUCT_CORE="$(cd "$SCRIPT_DIR/../../.." && pwd)"
CONSTRUCT_ROOT="$(cd "$CONSTRUCT_CORE/.." && pwd)"

echo -e "${BLUE}ğŸ”„ Refreshing plugin registry...${NC}"

# Output file
REGISTRY_FILE="$CONSTRUCT_CORE/patterns/plugins/registry.yaml"

# Start registry file
cat > "$REGISTRY_FILE" << 'EOF'
# CONSTRUCT Plugin Registry
# Auto-generated by refresh-plugin-registry.sh
# Last updated: $(date)

plugins:
  core:
    # Plugins shipped with CONSTRUCT-CORE
EOF

# Scan CORE plugins
echo -e "${YELLOW}Scanning CORE plugins...${NC}"
for category_dir in "$CONSTRUCT_CORE/patterns/plugins"/*; do
    [ -d "$category_dir" ] || continue
    category=$(basename "$category_dir")
    
    # Skip non-category directories
    [[ "$category" == "templates" || "$category" == "lib" ]] && continue
    
    for plugin_dir in "$category_dir"/*; do
        [ -d "$plugin_dir" ] || continue
        plugin_name=$(basename "$plugin_dir")
        plugin_path="$category/$plugin_name"
        
        # Check for metadata file
        if [ -f "$plugin_dir/$plugin_name.yaml" ]; then
            # Extract description from metadata
            description=$(grep "^description:" "$plugin_dir/$plugin_name.yaml" | sed 's/description: *//')
            version=$(grep "^version:" "$plugin_dir/$plugin_name.yaml" | sed 's/version: *//')
            
            # Check what components exist
            has_validators=false
            has_generators=false
            [ -d "$plugin_dir/validators" ] && has_validators=true
            [ -d "$plugin_dir/generators" ] && has_generators=true
            
            # Add to registry
            cat >> "$REGISTRY_FILE" << EOF
    $plugin_path:
      description: "$description"
      version: $version
      has_validators: $has_validators
      has_generators: $has_generators
EOF
        fi
    done
done

# Add LAB section
cat >> "$REGISTRY_FILE" << 'EOF'
  
  lab:
    # Project-specific plugins in CONSTRUCT-LAB
EOF

# Scan LAB plugins
if [ -d "$CONSTRUCT_ROOT/CONSTRUCT-LAB/patterns/plugins" ]; then
    echo -e "${YELLOW}Scanning LAB plugins...${NC}"
    for category_dir in "$CONSTRUCT_ROOT/CONSTRUCT-LAB/patterns/plugins"/*; do
        [ -d "$category_dir" ] || continue
        category=$(basename "$category_dir")
        
        for plugin_dir in "$category_dir"/*; do
            [ -d "$plugin_dir" ] || continue
            plugin_name=$(basename "$plugin_dir")
            plugin_path="$category/$plugin_name"
            
            if [ -f "$plugin_dir/$plugin_name.yaml" ]; then
                description=$(grep "^description:" "$plugin_dir/$plugin_name.yaml" | sed 's/description: *//')
                version=$(grep "^version:" "$plugin_dir/$plugin_name.yaml" | sed 's/version: *//')
                
                has_validators=false
                has_generators=false
                [ -d "$plugin_dir/validators" ] && has_validators=true
                [ -d "$plugin_dir/generators" ] && has_generators=true
                
                cat >> "$REGISTRY_FILE" << EOF
    $plugin_path:
      description: "$description"
      version: $version
      has_validators: $has_validators
      has_generators: $has_generators
EOF
            fi
        done
    done
fi

echo -e "${GREEN}âœ… Plugin registry updated: $REGISTRY_FILE${NC}"

# Show summary
core_count=$(grep -c "^    [^:]*:" "$REGISTRY_FILE" | head -1)
lab_count=$(grep -c "^    [^:]*:" "$REGISTRY_FILE" | tail -1)

echo "Found plugins:"
echo "  CORE: $core_count"
echo "  LAB: $lab_count"
```

### 2.2 Create Project Template Sets

**New File**: `patterns/templates/project-sets.yaml`

```yaml
# CONSTRUCT Project Template Sets
# Pre-configured plugin combinations for common project types

project_sets:
  ios:
    description: "iOS App with Swift and MVVM patterns"
    languages: 
      - swift
    plugins:
      - languages/swift
      - architectural/mvvm-ios
      - frameworks/swiftui
      - platforms/ios
      - tooling/shell-scripting
    
  web:
    description: "Web application with TypeScript/React"
    languages:
      - typescript
    plugins:
      - languages/typescript
      - frameworks/react
      - tooling/shell-scripting
      - tooling/error-handling
    
  api:
    description: "Backend API with C#/.NET"
    languages:
      - csharp
    plugins:
      - languages/csharp
      - frameworks/dotnet
      - tooling/shell-scripting
      - tooling/error-handling
    
  fullstack:
    description: "Full-stack application with multiple languages"
    languages:
      - swift
      - csharp
      - typescript
    plugins:
      - languages/swift
      - languages/csharp
      - languages/typescript
      - cross-platform/model-sync
      - tooling/shell-scripting
      
  construct-dev:
    description: "CONSTRUCT development environment"
    languages:
      - bash
      - python
    plugins:
      - tooling/construct-dev
      - tooling/shell-scripting
      - tooling/shell-quality
      - tooling/unix-philosophy
      
  # Custom templates can be added here
  run-app:
    description: "RUN full-stack (iOS + Watch + API)"
    languages:
      - swift
      - csharp
    plugins:
      - languages/swift
      - languages/csharp
      - architectural/mvvm-ios
      - cross-platform/model-sync
      - frameworks/swiftui
      - frameworks/ios-ui-library
      - platforms/ios
      - tooling/shell-scripting
```

### 2.3 Update create-project.sh

**File**: `scripts-new/workspace/create-project.sh`

Replace hardcoded project configurations (lines ~118-142) with:

```bash
# Load project sets
PROJECT_SETS_FILE="$CONSTRUCT_CORE/patterns/templates/project-sets.yaml"

# Configure patterns based on project type
if [ -f "$PROJECT_SETS_FILE" ]; then
    # Read from project-sets.yaml
    if command -v yq &> /dev/null; then
        LANGUAGES=$(yq eval ".project_sets.$PROJECT_TYPE.languages[]" "$PROJECT_SETS_FILE" | tr '\n' ',' | sed 's/,$//')
        SUGGESTED_PLUGINS=$(yq eval ".project_sets.$PROJECT_TYPE.plugins[]" "$PROJECT_SETS_FILE" | tr '\n' ',' | sed 's/,$//')
        DESCRIPTION=$(yq eval ".project_sets.$PROJECT_TYPE.description" "$PROJECT_SETS_FILE")
    else
        # Fallback to defaults if yq not available
        case $PROJECT_TYPE in
            "ios")
                LANGUAGES="swift"
                SUGGESTED_PLUGINS="tooling/shell-scripting"
                DESCRIPTION="iOS App with Swift and MVVM patterns"
                ;;
            # ... other cases
        esac
    fi
else
    # Original hardcoded logic as fallback
    case $PROJECT_TYPE in
        "ios")
            LANGUAGES="swift"
            SUGGESTED_PLUGINS="tooling/shell-scripting"
            DESCRIPTION="iOS App with Swift and MVVM patterns"
            ;;
        # ... rest of original cases
    esac
fi
```

Add plugin listing for custom selection:

```bash
# When showing available plugins, read from registry
if [[ "$PROJECT_TYPE" == "custom" ]] && [ -f "$CONSTRUCT_CORE/patterns/plugins/registry.yaml" ]; then
    echo -e "${BLUE}Available plugins from registry:${NC}"
    echo ""
    
    # Show CORE plugins
    echo "CORE plugins:"
    yq eval '.plugins.core | keys' "$CONSTRUCT_CORE/patterns/plugins/registry.yaml" | while read -r plugin; do
        plugin=$(echo "$plugin" | sed 's/^- //')
        desc=$(yq eval ".plugins.core.\"$plugin\".description" "$CONSTRUCT_CORE/patterns/plugins/registry.yaml")
        echo "  - $plugin: $desc"
    done
    
    # Show LAB plugins if any
    if yq eval '.plugins.lab' "$CONSTRUCT_CORE/patterns/plugins/registry.yaml" &>/dev/null; then
        echo ""
        echo "LAB plugins (project-specific):"
        yq eval '.plugins.lab | keys' "$CONSTRUCT_CORE/patterns/plugins/registry.yaml" | while read -r plugin; do
            plugin=$(echo "$plugin" | sed 's/^- //')
            desc=$(yq eval ".plugins.lab.\"$plugin\".description" "$CONSTRUCT_CORE/patterns/plugins/registry.yaml")
            echo "  - $plugin: $desc"
        done
    fi
    echo ""
fi
```

### 2.4 Update assemble-claude.sh

**File**: `scripts-new/construct/assemble-claude.sh`

Add new commands:

```bash
# Add to help section
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo "Usage: $0 <project-dir> <plugins> [options]"
    echo "       $0 --list-plugins"
    echo "       $0 --list-sets"
    echo "       $0 --refresh-registry"
    # ... rest of help
fi

# Handle new commands
if [[ "$1" == "--list-plugins" ]]; then
    # Show available plugins from registry
    REGISTRY_FILE="$CONSTRUCT_CORE/patterns/plugins/registry.yaml"
    if [ -f "$REGISTRY_FILE" ]; then
        echo -e "${BLUE}Available CONSTRUCT Plugins:${NC}"
        echo ""
        
        echo "CORE Plugins:"
        yq eval '.plugins.core' "$REGISTRY_FILE"
        
        if yq eval '.plugins.lab' "$REGISTRY_FILE" &>/dev/null; then
            echo ""
            echo "LAB Plugins:"
            yq eval '.plugins.lab' "$REGISTRY_FILE"
        fi
    else
        echo -e "${RED}Registry not found. Run: $0 --refresh-registry${NC}"
    fi
    exit 0
fi

if [[ "$1" == "--list-sets" ]]; then
    # Show project template sets
    PROJECT_SETS_FILE="$CONSTRUCT_CORE/patterns/templates/project-sets.yaml"
    if [ -f "$PROJECT_SETS_FILE" ]; then
        echo -e "${BLUE}Available Project Template Sets:${NC}"
        echo ""
        yq eval '.project_sets | to_entries | .[] | "\(.key): \(.value.description)"' "$PROJECT_SETS_FILE"
    else
        echo -e "${RED}Project sets file not found${NC}"
    fi
    exit 0
fi

if [[ "$1" == "--refresh-registry" ]]; then
    # Run registry refresh
    "$SCRIPT_DIR/refresh-plugin-registry.sh"
    exit 0
fi

# Validate plugins exist (add after plugin parsing)
if [ -f "$CONSTRUCT_CORE/patterns/plugins/registry.yaml" ]; then
    for plugin in "${PLUGIN_ARRAY[@]}"; do
        plugin=$(echo "$plugin" | xargs)
        if ! yq eval ".plugins.core.\"$plugin\" // .plugins.lab.\"$plugin\"" "$CONSTRUCT_CORE/patterns/plugins/registry.yaml" &>/dev/null; then
            echo -e "${YELLOW}âš ï¸  Warning: Plugin '$plugin' not found in registry${NC}"
        fi
    done
fi
```

## Phase 3: Clean Up Old Structure

### 3.1 Remove old pattern directories

```bash
# Remove empty directories and old files from scripts-new/patterns/
rm -rf scripts-new/patterns/code-quality/
rm -rf scripts-new/patterns/mvvm-architecture/
rm -rf scripts-new/patterns/python-development/

# Remove migrated validator files
rm -f scripts-new/patterns/*/validate-*.sh
rm -f scripts-new/patterns/*/generate-*.sh

# Keep README.md temporarily with migration notice
```

### 3.2 Update scripts-new/patterns/README.md

```markdown
# Pattern Validators - MIGRATED

Pattern validators have been moved to their respective plugin directories.

## New Location
Validators now live with their patterns:
- `patterns/plugins/[category]/[plugin-name]/validators/`
- `patterns/plugins/[category]/[plugin-name]/generators/`

## Migration Status
âœ… All validators have been migrated to plugin directories
âœ… Core scripts updated to check new locations
âœ… Backward compatibility maintained during transition

This directory will be removed after scripts-new migration is complete.
```

## Phase 4: Documentation Updates

### 4.1 Update scripts-new/README.md

Remove the patterns/ directory section and add:

```markdown
## Pattern Validators

Pattern validators are now bundled with their respective plugins in:
- `CONSTRUCT-CORE/patterns/plugins/[category]/[plugin-name]/validators/`
- `CONSTRUCT-CORE/patterns/plugins/[category]/[plugin-name]/generators/`

Core scripts automatically discover and run validators based on active patterns in `.construct/patterns.yaml`.
```

### 4.2 Update patterns/plugins/README.md

Add complete plugin structure:

```markdown
## Plugin Directory Structure

Each plugin is a self-contained package:

```
plugins/
â””â”€â”€ [category]/
    â””â”€â”€ [plugin-name]/
        â”œâ”€â”€ [plugin-name].md        # Pattern rules (required)
        â”œâ”€â”€ [plugin-name].yaml      # Metadata (required)
        â”œâ”€â”€ validators/             # Validation scripts
        â”‚   â”œâ”€â”€ quality.sh
        â”‚   â”œâ”€â”€ architecture.sh
        â”‚   â””â”€â”€ documentation.sh
        â”œâ”€â”€ generators/             # Generation scripts
        â”‚   â””â”€â”€ architecture.sh
        â”œâ”€â”€ examples/               # Example code
        â”‚   â”œâ”€â”€ good/
        â”‚   â””â”€â”€ bad/
        â””â”€â”€ tests/                  # Validator tests
            â”œâ”€â”€ should-pass/
            â””â”€â”€ should-fail/
```

## Plugin Registry

Run `construct-refresh-registry` to update the plugin registry after adding new plugins.

The registry is stored in `patterns/plugins/registry.yaml` and used by:
- `create-project.sh` - Shows available plugins
- `assemble-claude.sh` - Validates requested plugins exist
- `construct-patterns list` - Lists all available patterns
```

### 4.3 Update CONSTRUCT-LAB/patterns/README.md

Complete rewrite focusing on local development:

```markdown
# CONSTRUCT-LAB Patterns Directory

This directory is for **project-specific pattern development**. When working on your project in CONSTRUCT-LAB, you can develop and test custom patterns here before optionally sharing them.

## Directory Structure

```
patterns/
â”œâ”€â”€ plugins/             # Your project's local pattern plugins
â”œâ”€â”€ experiments/         # Experimental patterns being tested
â””â”€â”€ README.md           # This file
```

## Purpose

This is where you:
1. **Develop** patterns specific to your project
2. **Test** patterns before they're ready for distribution
3. **Override** or extend CORE patterns for your needs
4. **Package** patterns for sharing as separate repositories

## Creating Local Patterns

[Rest of content as previously planned...]
```

## Phase 5: Migrate scripts-new to scripts

### 5.1 Pre-migration checklist

- [ ] All validators moved to plugin directories
- [ ] Registry system implemented and tested
- [ ] Documentation updated
- [ ] No broken references to scripts-new/patterns/

### 5.2 Backup current scripts

```bash
# Create timestamped backup
BACKUP_DIR="scripts-backup-$(date +%Y%m%d-%H%M%S)"
cp -r scripts/ "$BACKUP_DIR/"
echo "Backup created: $BACKUP_DIR"
```

### 5.3 Perform migration

```bash
# Remove old scripts
rm -rf scripts/

# Move scripts-new to scripts
mv scripts-new/ scripts/

# Update any remaining references
# The scripts themselves use relative paths, so they should work
```

### 5.4 Update references

Files that may need updating:
- `.git/hooks/pre-commit` - Should already point to scripts/
- User's shell aliases - May need to re-run setup-aliases.sh
- Documentation - Update any references to scripts-new/

## Phase 6: Testing & Validation

### 6.1 Test critical paths

```bash
# Test pre-commit hook
git add . && git commit -m "test"

# Test pattern validation
./scripts/core/check-quality.sh

# Test architecture validation  
./scripts/core/check-architecture.sh

# Test project creation
./scripts/workspace/create-project.sh TestProject ios

# Test pattern assembly
./scripts/construct/assemble-claude.sh TestProject "languages/swift,architectural/mvvm-ios"

# Test registry refresh
./scripts/construct/refresh-plugin-registry.sh

# Test interactive support
./scripts/workspace/create-project.sh --show-prompts
```

### 6.2 Verify plugin functionality

```bash
# List available plugins
./scripts/construct/assemble-claude.sh --list-plugins

# List project sets
./scripts/construct/assemble-claude.sh --list-sets

# Verify validators run from new location
./scripts/core/check-quality.sh Projects/SomeProject
```

## Rollback Plan

If issues arise:

```bash
# Restore from backup
rm -rf scripts/
cp -r "$BACKUP_DIR/" scripts/

# Revert to scripts-new if needed
mv scripts/ scripts-broken/
mv scripts-new/ scripts/
```

## Success Criteria

- [ ] All scripts work from new location
- [ ] Pre-commit hooks pass
- [ ] Plugin validators run successfully
- [ ] Registry shows all available plugins
- [ ] create-project.sh uses project-sets.yaml
- [ ] No references to scripts-new remain
- [ ] Interactive support works in Claude Code

## Notes for Implementation

1. **Order matters**: Complete plugin structure before migrating scripts
2. **Test incrementally**: Test each phase before moving to next
3. **Keep backups**: Always backup before destructive operations
4. **Update aliases**: Users may need to re-run setup-aliases.sh
5. **Registry refresh**: Add to pre-commit hook for automatic updates

## Future Enhancements

After this migration:
1. Add examples/ and tests/ directories to plugins
2. Create plugin scaffold generator
3. Add plugin dependency resolution
4. Create plugin sharing/publishing mechanism
5. Remove backward compatibility code (checking old locations)