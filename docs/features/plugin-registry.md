# CONSTRUCT Plugin Registry System

## Overview

The CONSTRUCT Plugin Registry is a centralized system for discovering, managing, and loading pattern plugins. It provides a structured way to extend CONSTRUCT's functionality through modular patterns that can be mixed and matched for different project types.

## Architecture

### Registry Structure
```
CONSTRUCT/
‚îú‚îÄ‚îÄ CONSTRUCT-CORE/
‚îÇ   ‚îî‚îÄ‚îÄ patterns/plugins/
‚îÇ       ‚îú‚îÄ‚îÄ registry.yaml          # Core plugin registry
‚îÇ       ‚îú‚îÄ‚îÄ architectural/         # Architecture patterns
‚îÇ       ‚îú‚îÄ‚îÄ frameworks/           # Framework-specific patterns
‚îÇ       ‚îú‚îÄ‚îÄ languages/            # Language patterns
‚îÇ       ‚îú‚îÄ‚îÄ platforms/            # Platform patterns
‚îÇ       ‚îî‚îÄ‚îÄ tooling/              # Development tools
‚îî‚îÄ‚îÄ CONSTRUCT-LAB/
    ‚îî‚îÄ‚îÄ patterns/plugins/
        ‚îî‚îÄ‚îÄ registry.yaml         # Lab/experimental registry
```

### Registry Files

#### Location
- **Core Registry**: `CONSTRUCT-CORE/patterns/plugins/registry.yaml`
- **Lab Registry**: `CONSTRUCT-LAB/patterns/plugins/registry.yaml`

#### Format
```yaml
# CONSTRUCT Plugin Registry
# Auto-generated by refresh-plugin-registry.sh
# Last updated: Thu Jul 10 11:29:49 PDT 2025

plugins:
  core:
    # Plugins shipped with CONSTRUCT-CORE
    architectural/mvvm:
      description: "Model-View-ViewModel architectural pattern"
      version: "1.0.0"
      has_validators: true
      has_generators: false
    languages/swift:
      description: "Swift 6 language patterns"
      version: "1.0.0"
      has_validators: true
      has_generators: false
  lab:
    # Project-specific plugins in CONSTRUCT-LAB
    - id: tooling/shell-scripting/injections/consistency-standards
      name: "Script Interface Consistency Standards"
      description: "Ensures consistent flag support (--dry-run, --help) across all scripts in tooling systems"
      category: injection
      target: shell-scripting
      discovered: "2025-07-18"
      context: "CONSTRUCT construct-init testing revealed inconsistent validation approaches"
```

## Available Plugin Categories

### Architectural Patterns (`architectural/`)
- **mvvm** - Model-View-ViewModel pattern
- **mvvm-ios** - iOS-specific MVVM implementation

### Cross-Platform (`cross-platform/`)
- **model-sync** - Multi-platform model synchronization

### Frameworks (`frameworks/`)
- **swiftui** - SwiftUI best practices
- **ios-ui-library** - iOS UI component patterns
- **web** - Universal web framework patterns (React, Vue, Angular, vanilla JS)

### Languages (`languages/`)
- **swift** - Swift 6 patterns
- **python** - Python PEP 8 patterns
- **csharp** - C# modern patterns

### Platforms (`platforms/`)
- **ios** - iOS platform conventions
- **web** - Web platform patterns (PWA, SEO, browser APIs)

### Tooling (`tooling/`)
- **shell-scripting** - Shell script patterns
- **shell-quality** - Script quality standards
- **construct-dev** - CONSTRUCT development
- **error-handling** - Error handling patterns
- **unix-philosophy** - Unix design principles

### LAB Injections (`LAB/patterns/plugins/`)
- **tooling/shell-scripting/injections/consistency-standards** - Script interface consistency requirements (discovered 2025-07-18)

## Plugin Structure

### Required Files

Each plugin must have:
1. **`<plugin-name>.yaml`** - Plugin metadata and configuration (e.g., `swift.yaml`, `construct-dev.yaml`)
2. **`<plugin-name>.md`** - Human-readable pattern documentation
3. **Optional directories**:
   - `validators/` - Scripts to validate pattern compliance
   - `generators/` - Scripts to generate code/documentation
   - `injections/` - Content to inject into CLAUDE.md
   - `examples/` - Example implementations

### Plugin Metadata (`<plugin-name>.yaml`)

```yaml
name: swift-language
version: 1.0.0
description: Swift 6 language patterns and best practices for iOS development
author: CONSTRUCT Team
category: languages
validators:
  - quality
dependencies:
  - architectural/mvvm-ios
  - frameworks/swiftui
tags:
  - swift
  - ios
  - swift-6
  - concurrency
  - mobile
min_construct_version: 2.0.0
```

## Registry Generation

### The refresh-plugin-registry.sh Script

This script scans all plugin directories and generates the registry:

```bash
# Run from any directory
./CONSTRUCT-CORE/CONSTRUCT/scripts/construct/refresh-plugin-registry.sh

# What it does:
1. Scans CONSTRUCT-CORE/patterns/plugins/*
2. Scans CONSTRUCT-LAB/patterns/plugins/*
3. Reads pattern.yaml from each plugin
4. Checks for validators/ and generators/
5. Generates registry.yaml with metadata
```

### Output Example
```
üîÑ Refreshing plugin registry...
Scanning CORE plugins...
Scanning LAB plugins...
‚úÖ Plugin registry updated: .../registry.yaml

Found plugins:
  CORE: 14
  LAB: 0

CORE plugins:
  - Model-View-ViewModel architectural pattern
  - Swift 6 language patterns and best practices
  - iOS platform-specific patterns and conventions
  ...
```

## Registry Usage

### By create-project.sh

Shows available plugins when creating new projects:

```bash
./create-project.sh MyApp ios

# Uses registry to show:
Available plugins:
  - languages/swift
  - platforms/ios
  - frameworks/swiftui
  - architectural/mvvm
```

### By assemble-claude.sh

Lists plugins and validates requested patterns:

```bash
./assemble-claude.sh --list-plugins

# Reads from registry.yaml to show all available plugins
```

### By init-construct.sh

Currently reads patterns.yaml directly but should use registry for validation:

```yaml
# .construct/patterns.yaml
plugins:
  - languages/swift        # Validated against registry
  - platforms/ios         # Checked for existence
  - frameworks/swiftui    # Dependencies resolved
```

### By workspace scripts

Workspace management scripts use a separate workspace registry:
- `workspace-status.sh` - Shows project patterns
- `workspace-update.sh` - Updates all projects
- `import-project.sh` - Records imported projects

## LAB Injections

### What are Injections?

**Injections** are small, focused pattern additions that extend existing CORE patterns without replacing them. They're perfect for:

- **Newly discovered best practices** learned through real development
- **Architectural decisions** that need to be preserved
- **Project-specific extensions** to standard patterns
- **Experimental improvements** that might eventually become CORE patterns

### Creating an Injection

```bash
# 1. Create injection directory
mkdir -p CONSTRUCT-LAB/patterns/plugins/tooling/shell-scripting/injections

# 2. Create the injection file
cat > CONSTRUCT-LAB/patterns/plugins/tooling/shell-scripting/injections/my-discovery.md << 'EOF'
# My Discovery

## When to Use
Description of when this injection applies

## Rules
New patterns discovered through development
EOF

# 3. MANDATORY: Create validator for the injection
mkdir -p CONSTRUCT-LAB/patterns/plugins/tooling/shell-scripting/injections/validators
cat > CONSTRUCT-LAB/patterns/plugins/tooling/shell-scripting/injections/validators/my-discovery-validator.sh << 'EOF'
#!/bin/bash
# Validator for my-discovery injection
# MANDATORY: Every injection must have a validator

set -e
ISSUES_FOUND=0

echo "üîç Validating my-discovery patterns..."

# Add specific validation logic here
# Example: Check for required patterns, file formats, etc.

if [ $ISSUES_FOUND -eq 0 ]; then
    echo "‚úÖ All my-discovery patterns validated"
else
    echo "‚ùå Found $ISSUES_FOUND violations"
fi

exit $ISSUES_FOUND
EOF

chmod +x CONSTRUCT-LAB/patterns/plugins/tooling/shell-scripting/injections/validators/my-discovery-validator.sh

# 4. Add to patterns.yaml
echo "injections:" >> .construct/patterns.yaml
echo "  - tooling/shell-scripting/injections/my-discovery" >> .construct/patterns.yaml

# 5. Update registry
./CONSTRUCT-CORE/CONSTRUCT/scripts/construct/refresh-plugin-registry.sh
```

**üö® CRITICAL**: Every injection MUST have a validator - no exceptions.

### Example: consistency-standards Injection

The `consistency-standards` injection was discovered during CONSTRUCT construct-init testing when we found inconsistent script interfaces. It now ensures all scripts support `--dry-run` and `--help` consistently.

**Discovery context**: Testing revealed some scripts used `--help` for validation while others used `--dry-run`, creating inconsistent user experience.

**Solution**: Document the requirement that all file-modifying scripts must support both flags consistently.

## Creating New Plugins

### Step 1: Create Plugin Directory

```bash
# Choose appropriate category
mkdir -p CONSTRUCT-CORE/patterns/plugins/languages/rust
cd CONSTRUCT-CORE/patterns/plugins/languages/rust
```

### Step 2: Create pattern.yaml

```yaml
name: rust
description: Rust language patterns and best practices
version: 1.0.0
author: Your Name

provides:
  guidelines:
    - Memory safety patterns
    - Error handling with Result
    - Ownership best practices
  
  validators:
    - cargo-check.sh
    - clippy-validator.sh

tags:
  - language
  - rust
  - systems

compatible_with:
  platforms: ["darwin", "linux", "windows"]
```

### Step 3: Create pattern.md

```markdown
# Rust Language Patterns

## Overview
This pattern provides Rust language best practices...

## Guidelines
- Use Result<T, E> for error handling
- Prefer iterators over loops
- Use lifetime annotations explicitly

## Anti-patterns
- Unwrapping without handling errors
- Excessive cloning
- Fighting the borrow checker
```

### Step 4: Add Validators (MANDATORY)

```bash
mkdir validators
cat > validators/rust-patterns.sh << 'EOF'
#!/bin/bash
# Validate Rust patterns compliance
# MANDATORY: Every plugin must have validators
set -e

ISSUES_FOUND=0

echo "üîç Validating Rust pattern compliance..."

# Check for Result usage instead of unwrap
if grep -r "\.unwrap()" . --include="*.rs" >/dev/null 2>&1; then
    echo "‚ùå Found .unwrap() usage - use proper error handling"
    ISSUES_FOUND=$((ISSUES_FOUND + 1))
fi

# Check for proper error handling
if ! grep -r "Result<" . --include="*.rs" >/dev/null 2>&1; then
    echo "‚ùå No Result types found - add proper error handling"
    ISSUES_FOUND=$((ISSUES_FOUND + 1))
fi

echo "üîç Running cargo check..."
if ! cargo check --all-targets >/dev/null 2>&1; then
    echo "‚ùå Cargo check failed"
    ISSUES_FOUND=$((ISSUES_FOUND + 1))
fi

echo "üîç Running clippy..."
if ! cargo clippy -- -D warnings >/dev/null 2>&1; then
    echo "‚ùå Clippy warnings found"
    ISSUES_FOUND=$((ISSUES_FOUND + 1))
fi

if [ $ISSUES_FOUND -eq 0 ]; then
    echo "‚úÖ All Rust patterns validated successfully"
else
    echo "‚ùå Found $ISSUES_FOUND Rust pattern violations"
fi

exit $ISSUES_FOUND
EOF

chmod +x validators/rust-patterns.sh
```

**‚ö†Ô∏è CRITICAL**: Validators are not optional - they're mandatory for every plugin and injection.

### Step 5: Add Injections (Optional)

```bash
mkdir injections
cat > injections/guidelines.md << 'EOF'
### Rust Development Guidelines

#### Error Handling
\`\`\`rust
// ‚úÖ ALWAYS: Use Result for fallible operations
fn parse_config() -> Result<Config, Error> {
    // ...
}

// ‚ùå NEVER: Unwrap without context
let config = parse_config().unwrap();
\`\`\`
EOF
```

### Step 6: Refresh Registry

```bash
./CONSTRUCT-CORE/CONSTRUCT/scripts/construct/refresh-plugin-registry.sh
```

## Best Practices

### Plugin Design

1. **Single Responsibility**: Each plugin should focus on one aspect
2. **Clear Dependencies**: Declare requirements in pattern.yaml
3. **Documentation**: Comprehensive pattern.md is essential
4. **Examples**: Provide real-world usage examples
5. **üö® MANDATORY: Validators**: Every plugin and injection MUST have validators that enforce the documented patterns

### ‚úÖ DO: Validator Requirements
- **Every plugin** must include a `validators/` directory with enforcement scripts
- **Every injection** must include a `validators/` directory that validates the specific rules
- **Validators must be executable** and follow standard exit codes (0=success, >0=issues found)
- **Validators must provide clear feedback** about what violations were found
- **No pattern without enforcement** - if you can't validate it, don't document it

### Naming Conventions

- **Categories**: lowercase, plural (languages/, frameworks/)
- **Plugin names**: lowercase, hyphenated (swift-ui, error-handling)
- **Versions**: Semantic versioning (1.0.0)

### Content Guidelines

1. **Injections**: Should be self-contained and contextual
2. **Validators**: Exit codes indicate issues found
3. **Generators**: Should be idempotent
4. **Documentation**: Include both DO and DON'T examples

## Integration with Two-Stage Init

### How Plugins Enhance CLAUDE.md

1. **Stage 1**: User runs `/init` to create base CLAUDE.md
2. **Stage 2**: `construct-init` reads patterns.yaml and:
   - Validates requested plugins exist in registry
   - Loads injection content from each plugin
   - Merges content at injection points
   - Preserves /init content where appropriate

### Injection Points

```markdown
{{CONSTRUCT:HEADER}}      # Warning about pattern management
{{CONSTRUCT:PATTERNS}}    # Active patterns list
{{CONSTRUCT:GUIDELINES}}  # Merged guidelines from all plugins
{{CONSTRUCT:STRUCTURE}}   # Project structure info
{{CONSTRUCT:EXAMPLES}}    # Code examples from plugins
{{CONSTRUCT:COMMANDS}}    # Quick commands from patterns
{{CONSTRUCT:CONTEXT}}     # Dynamic project context
```

## Troubleshooting

### Common Issues

#### Registry Not Found
```bash
# Ensure you're in CONSTRUCT root
cd /path/to/CONSTRUCT
./CONSTRUCT-CORE/CONSTRUCT/scripts/construct/refresh-plugin-registry.sh
```

#### Plugin Not Listed
- Check pattern.yaml exists and is valid YAML
- Ensure plugin is in correct category directory
- Run refresh-plugin-registry.sh after adding

#### Validation Failures
- Validators should output clear error messages
- Exit code = number of issues found
- Check validator has execute permissions

#### Missing Dependencies
```bash
# Install required tools
brew install yq  # For YAML parsing
```

### Debugging

```bash
# Check registry contents
cat CONSTRUCT-CORE/patterns/plugins/registry.yaml

# Validate specific plugin
ls -la CONSTRUCT-CORE/patterns/plugins/languages/swift/

# Test validator
./CONSTRUCT-CORE/patterns/plugins/languages/swift/validators/swift-quality.sh

# Check pattern.yaml syntax
yq eval . pattern.yaml
```

## Future Enhancements

### Planned Features

1. **Plugin Dependencies**: Automatic resolution and loading
2. **Version Compatibility**: Check plugin versions against CONSTRUCT
3. **Remote Plugins**: Load from git repositories
4. **Plugin Testing**: Automated test framework
5. **Hot Reloading**: Update patterns without restart

### Registry API

Future versions may include:
- RESTful API for plugin discovery
- Package manager integration
- Community plugin repository
- Plugin signing and verification

## Related Documentation

- [Init and Construct Init](./init-and-construct-init.md)
- [Workspace Management](../core/workspace-management.md)
- [Interactive Scripts](./interactive-scripts.md)
- [Repository Context](./repository-context.md)